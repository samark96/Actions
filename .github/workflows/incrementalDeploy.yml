name: incrementalDeploy

on:
  push:
    branches: [ "main" ]
    #paths:
    #  -  'force-app/**'  
  workflow_dispatch:
env:
  personalToken: ${{ secrets.personalToken }}

jobs:
  incrementalDeploy:
    runs-on: windows-latest
    environment: prod
    env:
      fromCommitId: ${{ vars.fromCommitId }}
    
    steps:
      - name: 'checkout source code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'getChanges'
        shell: pwsh
        run: |
          ./build/customScripts/incrementalDeploy.ps1
      
      - name: 'exportSecret'
        run: |
          echo "${{ secrets.secureKey }}" > server.key

      - name: Extract Salesforce CLI
        run: |
          mkdir sfCLI
          tar -xzvf build/sf-win32-x64.tar.gz -C sfCLI --strip-components=1
  
      - name: Test Salesforce CLI
        run: |
          ./sfCLI/bin/sfdx --version
          ./sfCLI/bin/sfdx plugins --core
      
      - name: 'sfAuth'
        run: |
          ./sfCLI/bin/sfdx force:auth:jwt:grant --username ${{ vars.userName }} --jwt-key-file=server.key --client-id ${{ vars.consumerKey }} --instance-url ${{ vars.instanceURL }} --alias ${{ vars.orgAlias }}

      - name: 'incrementalDeploy'
        run: |
          ./sfCLI/bin/sfdx force:source:deploy --loglevel ${{ vars.logLevel }} --targetusername ${{ vars.orgAlias }} --testlevel ${{ vars.testLevel }} --sourcepath ${{ vars.sourcePath }} --wait ${{ vars.deployWait }}

      - name: 'updateVariable'
        run: |
          ./build/customScripts/updateVariable.ps1